#include <dt/fill.hpp>
#include <dt/generalised_distance_transform.hpp>
#include <dt/image2d_view.hpp>
#include <dt/imprint.hpp>
#include <dt/random_image2d.hpp>
#include <dt/transfert.hpp>

#include <gtest/gtest.h>

#include <cstring>

#include "helpers.hpp"

TEST(DistanceTransform, EuclidianFastGeodis)
{
  static constexpr int WIDTH  = 50;
  static constexpr int HEIGHT = 40;

  float ref_data[] = {
      28.284266, 27.870052,  27.45584,  27.041626, 26.627413, 26.213198,  25.798985, 25.384771,  24.970558, 24.556345,
      24.142132, 23.727919,  23.313705, 22.899492, 22.48528,  22.071066,  21.656853, 21.24264,   20.828426, 20.414213,
      20.0,      20.0,       20.0,      20.0,      20.0,      20.0,       20.0,      20.0,       20.0,      20.0,
      20.0,      20.0,       20.0,      20.0,      20.0,      20.0,       20.0,      20.0,       20.0,      20.0,
      20.0,      20.0,       20.0,      20.414213, 20.828426, 21.24264,   21.656853, 22.071066,  22.48528,
      22.899492, //
      27.870052, 26.870052,  26.45584,  26.041626, 25.627413, 25.2132,    24.798985, 24.384771,  23.970558, 23.556345,
      23.142132, 22.727919,  22.313705, 21.899492, 21.48528,  21.071066,  20.656853, 20.24264,   19.828426, 19.414213,
      19.0,      19.0,       19.0,      19.0,      19.0,      19.0,       19.0,      19.0,       19.0,      19.0,
      19.0,      19.0,       19.0,      19.0,      19.0,      19.0,       19.0,      19.0,       19.0,      19.0,
      19.0,      19.0,       19.0,      19.414213, 19.828426, 20.24264,   20.656853, 21.071066,  21.48528,
      21.899492, //
      27.45584,  26.45584,   25.45584,  25.041626, 24.627413, 24.2132,    23.798986, 23.384771,  22.970558, 22.556345,
      22.142132, 21.727919,  21.313705, 20.899492, 20.48528,  20.071066,  19.656853, 19.24264,   18.828426, 18.414213,
      18.0,      18.0,       18.0,      18.0,      18.0,      18.0,       18.0,      18.0,       18.0,      18.0,
      18.0,      18.0,       18.0,      18.0,      18.0,      18.0,       18.0,      18.0,       18.0,      18.0,
      18.0,      18.0,       18.0,      18.414213, 18.828426, 19.24264,   19.656853, 20.071066,  20.48528,
      20.899492, //
      27.041626, 26.041626,  25.041626, 24.041626, 23.627413, 23.2132,    22.798986, 22.384773,  21.970558, 21.556345,
      21.142132, 20.727919,  20.313705, 19.899492, 19.48528,  19.071066,  18.656853, 18.24264,   17.828426, 17.414213,
      17.0,      17.0,       17.0,      17.0,      17.0,      17.0,       17.0,      17.0,       17.0,      17.0,
      17.0,      17.0,       17.0,      17.0,      17.0,      17.0,       17.0,      17.0,       17.0,      17.0,
      17.0,      17.0,       17.0,      17.414213, 17.828426, 18.24264,   18.656853, 19.071066,  19.48528,
      19.899492, //
      26.627413, 25.627413,  24.627413, 23.627413, 22.627413, 22.2132,    21.798986, 21.384773,  20.97056,  20.556345,
      20.142132, 19.727919,  19.313705, 18.899492, 18.48528,  18.071066,  17.656853, 17.24264,   16.828426, 16.414213,
      16.0,      16.0,       16.0,      16.0,      16.0,      16.0,       16.0,      16.0,       16.0,      16.0,
      16.0,      16.0,       16.0,      16.0,      16.0,      16.0,       16.0,      16.0,       16.0,      16.0,
      16.0,      16.0,       16.0,      16.414213, 16.828426, 17.24264,   17.656853, 18.071066,  18.48528,
      18.899492, //
      26.213198, 25.2132,    24.2132,   23.2132,   22.2132,   21.2132,    20.798986, 20.384773,  19.97056,  19.556347,
      19.142132, 18.727919,  18.313705, 17.899492, 17.48528,  17.071066,  16.656853, 16.24264,   15.828426, 15.414213,
      15.0,      15.0,       15.0,      15.0,      15.0,      15.0,       15.0,      15.0,       15.0,      15.0,
      15.0,      15.0,       15.0,      15.0,      15.0,      15.0,       15.0,      15.0,       15.0,      15.0,
      15.0,      15.0,       15.0,      15.414213, 15.828426, 16.24264,   16.656853, 17.071066,  17.48528,
      17.899492, //
      25.798985, 24.798985,  23.798986, 22.798986, 21.798986, 20.798986,  19.798986, 19.384773,  18.97056,  18.556347,
      18.142134, 17.727919,  17.313705, 16.899492, 16.48528,  16.071066,  15.656853, 15.24264,   14.828426, 14.414213,
      14.0,      14.0,       14.0,      14.0,      14.0,      14.0,       14.0,      14.0,       14.0,      14.0,
      14.0,      14.0,       14.0,      14.0,      14.0,      14.0,       14.0,      14.0,       14.0,      14.0,
      14.0,      14.0,       14.0,      14.414213, 14.828426, 15.24264,   15.656853, 16.071066,  16.48528,
      16.899492, //
      25.384771, 24.384771,  23.384771, 22.384773, 21.384773, 20.384773,  19.384773, 18.384773,  17.97056,  17.556347,
      17.142134, 16.72792,   16.313705, 15.899493, 15.485279, 15.071066,  14.656853, 14.24264,   13.828426, 13.414213,
      13.0,      13.0,       13.0,      13.0,      13.0,      13.0,       13.0,      13.0,       13.0,      13.0,
      13.0,      13.0,       13.0,      13.0,      13.0,      13.0,       13.0,      13.0,       13.0,      13.0,
      13.0,      13.0,       13.0,      13.414213, 13.828426, 14.24264,   14.656853, 15.071066,  15.485279,
      15.899493, //
      24.970558, 23.970558,  22.970558, 21.970558, 20.97056,  19.97056,   18.97056,  17.97056,   16.97056,  16.556347,
      16.142134, 15.72792,   15.313706, 14.899493, 14.48528,  14.071066,  13.656853, 13.24264,   12.828426, 12.414213,
      12.0,      12.0,       12.0,      12.0,      12.0,      12.0,       12.0,      12.0,       12.0,      12.0,
      12.0,      12.0,       12.0,      12.0,      12.0,      12.0,       12.0,      12.0,       12.0,      12.0,
      12.0,      12.0,       12.0,      12.414213, 12.828426, 13.24264,   13.656853, 14.071066,  14.48528,
      14.899493, //
      24.556345, 23.556345,  22.556345, 21.556345, 20.556345, 19.556347,  18.556347, 17.556347,  16.556347, 15.556347,
      15.142134, 14.727921,  14.313706, 13.899493, 13.48528,  13.071067,  12.656853, 12.24264,   11.828426, 11.414213,
      11.0,      11.0,       11.0,      11.0,      11.0,      11.0,       11.0,      11.0,       11.0,      11.0,
      11.0,      11.0,       11.0,      11.0,      11.0,      11.0,       11.0,      11.0,       11.0,      11.0,
      11.0,      11.0,       11.0,      11.414213, 11.828426, 12.24264,   12.656853, 13.071067,  13.48528,
      13.899493, //
      24.142132, 23.142132,  22.142132, 21.142132, 20.142132, 19.142132,  18.142134, 17.142134,  16.142134, 15.142134,
      14.142134, 13.727921,  13.313707, 12.899493, 12.48528,  12.071067,  11.656854, 11.24264,   10.828426, 10.414213,
      10.0,      10.0,       10.0,      10.0,      10.0,      10.0,       10.0,      10.0,       10.0,      10.0,
      10.0,      10.0,       10.0,      10.0,      10.0,      10.0,       10.0,      10.0,       10.0,      10.0,
      10.0,      10.0,       10.0,      10.414213, 10.828426, 11.24264,   11.656854, 12.071067,  12.48528,
      12.899493, //
      23.727919, 22.727919,  21.727919, 20.727919, 19.727919, 18.727919,  17.727919, 16.72792,   15.72792,  14.727921,
      13.727921, 12.727921,  12.313707, 11.899494, 11.48528,  11.071067,  10.656854, 10.2426405, 9.828426,  9.414213,
      9.0,       9.0,        9.0,       9.0,       9.0,       9.0,        9.0,       9.0,        9.0,       9.0,
      9.0,       9.0,        9.0,       9.0,       9.0,       9.0,        9.0,       9.0,        9.0,       9.0,
      9.0,       9.0,        9.0,       9.414213,  9.828426,  10.2426405, 10.656854, 11.071067,  11.48528,
      11.899494, //
      23.313705, 22.313705,  21.313705, 20.313705, 19.313705, 18.313705,  17.313705, 16.313705,  15.313706, 14.313706,
      13.313707, 12.313707,  11.313707, 10.899494, 10.485281, 10.071067,  9.656854,  9.2426405,  8.828427,  8.414213,
      8.0,       8.0,        8.0,       8.0,       8.0,       8.0,        8.0,       8.0,        8.0,       8.0,
      8.0,       8.0,        8.0,       8.0,       8.0,       8.0,        8.0,       8.0,        8.0,       8.0,
      8.0,       8.0,        8.0,       8.414213,  8.828427,  9.2426405,  9.656854,  10.071067,  10.485281,
      10.899494, //
      22.899492, 21.899492,  20.899492, 19.899492, 18.899492, 17.899492,  16.899492, 15.899493,  14.899493, 13.899493,
      12.899493, 11.899494,  10.899494, 9.899494,  9.485281,  9.071068,   8.656854,  8.2426405,  7.8284273, 7.4142137,
      7.0,       7.0,        7.0,       7.0,       7.0,       7.0,        7.0,       7.0,        7.0,       7.0,
      7.0,       7.0,        7.0,       7.0,       7.0,       7.0,        7.0,       7.0,        7.0,       7.0,
      7.0,       7.0,        7.0,       7.4142137, 7.8284273, 8.2426405,  8.656854,  9.071068,   9.485281,
      9.899494, //
      22.48528,  21.48528,   20.48528,  19.48528,  18.48528,  17.48528,   16.48528,  15.485279,  14.48528,  13.48528,
      12.48528,  11.48528,   10.485281, 9.485281,  8.485281,  8.071068,   7.656854,  7.2426405,  6.8284273, 6.4142137,
      6.0,       6.0,        6.0,       6.0,       6.0,       6.0,        6.0,       6.0,        6.0,       6.0,
      6.0,       6.0,        6.0,       6.0,       6.0,       6.0,        6.0,       6.0,        6.0,       6.0,
      6.0,       6.0,        6.0,       6.4142137, 6.8284273, 7.2426405,  7.656854,  8.071068,   8.485281,
      9.485281, //
      22.071066, 21.071066,  20.071066, 19.071066, 18.071066, 17.071066,  16.071066, 15.071066,  14.071066, 13.071067,
      12.071067, 11.071067,  10.071067, 9.071068,  8.071068,  7.071068,   6.656854,  6.2426405,  5.8284273, 5.4142137,
      5.0,       5.0,        5.0,       5.0,       5.0,       5.0,        5.0,       5.0,        5.0,       5.0,
      5.0,       5.0,        5.0,       5.0,       5.0,       5.0,        5.0,       5.0,        5.0,       5.0,
      5.0,       5.0,        5.0,       5.4142137, 5.8284273, 6.2426405,  6.656854,  7.071068,   8.071068,
      9.071068, //
      21.656853, 20.656853,  19.656853, 18.656853, 17.656853, 16.656853,  15.656853, 14.656853,  13.656853, 12.656853,
      11.656854, 10.656854,  9.656854,  8.656854,  7.656854,  6.656854,   5.656854,  5.2426405,  4.8284273, 4.4142137,
      4.0,       4.0,        4.0,       4.0,       4.0,       4.0,        4.0,       4.0,        4.0,       4.0,
      4.0,       4.0,        4.0,       4.0,       4.0,       4.0,        4.0,       4.0,        4.0,       4.0,
      4.0,       4.0,        4.0,       4.4142137, 4.8284273, 5.2426405,  5.656854,  6.656854,   7.656854,
      8.656854, //
      21.24264,  20.24264,   19.24264,  18.24264,  17.24264,  16.24264,   15.24264,  14.24264,   13.24264,  12.24264,
      11.24264,  10.2426405, 9.2426405, 8.2426405, 7.2426405, 6.2426405,  5.2426405, 4.2426405,  3.828427,  3.4142137,
      3.0,       3.0,        3.0,       3.0,       3.0,       3.0,        3.0,       3.0,        3.0,       3.0,
      3.0,       3.0,        3.0,       3.0,       3.0,       3.0,        3.0,       3.0,        3.0,       3.0,
      3.0,       3.0,        3.0,       3.4142137, 3.828427,  4.2426405,  5.2426405, 6.2426405,  7.2426405,
      8.2426405, //
      20.828426, 19.828426,  18.828426, 17.828426, 16.828426, 15.828426,  14.828426, 13.828426,  12.828426, 11.828426,
      10.828426, 9.828426,   8.828427,  7.8284273, 6.8284273, 5.8284273,  4.8284273, 3.828427,   2.828427,  2.4142137,
      2.0,       2.0,        2.0,       2.0,       2.0,       2.0,        2.0,       2.0,        2.0,       2.0,
      2.0,       2.0,        2.0,       2.0,       2.0,       2.0,        2.0,       2.0,        2.0,       2.0,
      2.0,       2.0,        2.0,       2.4142137, 2.828427,  3.828427,   4.8284273, 5.8284273,  6.8284273,
      7.8284273, //
      20.414213, 19.414213,  18.414213, 17.414213, 16.414213, 15.414213,  14.414213, 13.414213,  12.414213, 11.414213,
      10.414213, 9.414213,   8.414213,  7.4142137, 6.4142137, 5.4142137,  4.4142137, 3.4142137,  2.4142137, 1.4142135,
      1.0,       1.0,        1.0,       1.0,       1.0,       1.0,        1.0,       1.0,        1.0,       1.0,
      1.0,       1.0,        1.0,       1.0,       1.0,       1.0,        1.0,       1.0,        1.0,       1.0,
      1.0,       1.0,        1.0,       1.4142135, 2.4142137, 3.4142137,  4.4142137, 5.4142137,  6.4142137,
      7.4142137, //
      20.0,      19.0,       18.0,      17.0,      16.0,      15.0,       14.0,      13.0,       12.0,      11.0,
      10.0,      9.0,        8.0,       7.0,       6.0,       5.0,        4.0,       3.0,        2.0,       1.0,
      0.0,       0.0,        0.0,       0.0,       0.0,       0.0,        0.0,       0.0,        0.0,       0.0,
      0.0,       0.0,        0.0,       0.0,       0.0,       0.0,        0.0,       0.0,        0.0,       0.0,
      0.0,       0.0,        0.0,       1.0,       2.0,       3.0,        4.0,       5.0,        6.0,
      7.0, //
      20.0,      19.0,       18.0,      17.0,      16.0,      15.0,       14.0,      13.0,       12.0,      11.0,
      10.0,      9.0,        8.0,       7.0,       6.0,       5.0,        4.0,       3.0,        2.0,       1.0,
      0.0,       0.0,        0.0,       0.0,       0.0,       0.0,        0.0,       0.0,        0.0,       0.0,
      0.0,       0.0,        0.0,       0.0,       0.0,       0.0,        0.0,       0.0,        0.0,       0.0,
      0.0,       0.0,        0.0,       1.0,       2.0,       3.0,        4.0,       5.0,        6.0,
      7.0, //
      20.0,      19.0,       18.0,      17.0,      16.0,      15.0,       14.0,      13.0,       12.0,      11.0,
      10.0,      9.0,        8.0,       7.0,       6.0,       5.0,        4.0,       3.0,        2.0,       1.0,
      0.0,       0.0,        0.0,       0.0,       0.0,       0.0,        0.0,       0.0,        0.0,       0.0,
      0.0,       0.0,        0.0,       0.0,       0.0,       0.0,        0.0,       0.0,        0.0,       0.0,
      0.0,       0.0,        0.0,       1.0,       2.0,       3.0,        4.0,       5.0,        6.0,
      7.0, //
      20.0,      19.0,       18.0,      17.0,      16.0,      15.0,       14.0,      13.0,       12.0,      11.0,
      10.0,      9.0,        8.0,       7.0,       6.0,       5.0,        4.0,       3.0,        2.0,       1.0,
      0.0,       0.0,        0.0,       0.0,       0.0,       0.0,        0.0,       0.0,        0.0,       0.0,
      0.0,       0.0,        0.0,       0.0,       0.0,       0.0,        0.0,       0.0,        0.0,       0.0,
      0.0,       0.0,        0.0,       1.0,       2.0,       3.0,        4.0,       5.0,        6.0,
      7.0, //
      20.0,      19.0,       18.0,      17.0,      16.0,      15.0,       14.0,      13.0,       12.0,      11.0,
      10.0,      9.0,        8.0,       7.0,       6.0,       5.0,        4.0,       3.0,        2.0,       1.0,
      0.0,       0.0,        0.0,       0.0,       0.0,       0.0,        0.0,       0.0,        0.0,       0.0,
      0.0,       0.0,        0.0,       0.0,       0.0,       0.0,        0.0,       0.0,        0.0,       0.0,
      0.0,       0.0,        0.0,       1.0,       2.0,       3.0,        4.0,       5.0,        6.0,
      7.0, //
      20.0,      19.0,       18.0,      17.0,      16.0,      15.0,       14.0,      13.0,       12.0,      11.0,
      10.0,      9.0,        8.0,       7.0,       6.0,       5.0,        4.0,       3.0,        2.0,       1.0,
      0.0,       0.0,        0.0,       0.0,       0.0,       0.0,        0.0,       0.0,        0.0,       0.0,
      0.0,       0.0,        0.0,       0.0,       0.0,       0.0,        0.0,       0.0,        0.0,       0.0,
      0.0,       0.0,        0.0,       1.0,       2.0,       3.0,        4.0,       5.0,        6.0,
      7.0, //
      20.0,      19.0,       18.0,      17.0,      16.0,      15.0,       14.0,      13.0,       12.0,      11.0,
      10.0,      9.0,        8.0,       7.0,       6.0,       5.0,        4.0,       3.0,        2.0,       1.0,
      0.0,       0.0,        0.0,       0.0,       0.0,       0.0,        0.0,       0.0,        0.0,       0.0,
      0.0,       0.0,        0.0,       0.0,       0.0,       0.0,        0.0,       0.0,        0.0,       0.0,
      0.0,       0.0,        0.0,       1.0,       2.0,       3.0,        4.0,       5.0,        6.0,
      7.0, //
      20.0,      19.0,       18.0,      17.0,      16.0,      15.0,       14.0,      13.0,       12.0,      11.0,
      10.0,      9.0,        8.0,       7.0,       6.0,       5.0,        4.0,       3.0,        2.0,       1.0,
      0.0,       0.0,        0.0,       0.0,       0.0,       0.0,        0.0,       0.0,        0.0,       0.0,
      0.0,       0.0,        0.0,       0.0,       0.0,       0.0,        0.0,       0.0,        0.0,       0.0,
      0.0,       0.0,        0.0,       1.0,       2.0,       3.0,        4.0,       5.0,        6.0,
      7.0, //
      20.0,      19.0,       18.0,      17.0,      16.0,      15.0,       14.0,      13.0,       12.0,      11.0,
      10.0,      9.0,        8.0,       7.0,       6.0,       5.0,        4.0,       3.0,        2.0,       1.0,
      0.0,       0.0,        0.0,       0.0,       0.0,       0.0,        0.0,       0.0,        0.0,       0.0,
      0.0,       0.0,        0.0,       0.0,       0.0,       0.0,        0.0,       0.0,        0.0,       0.0,
      0.0,       0.0,        0.0,       1.0,       2.0,       3.0,        4.0,       5.0,        6.0,
      7.0, //
      20.0,      19.0,       18.0,      17.0,      16.0,      15.0,       14.0,      13.0,       12.0,      11.0,
      10.0,      9.0,        8.0,       7.0,       6.0,       5.0,        4.0,       3.0,        2.0,       1.0,
      0.0,       0.0,        0.0,       0.0,       0.0,       0.0,        0.0,       0.0,        0.0,       0.0,
      0.0,       0.0,        0.0,       0.0,       0.0,       0.0,        0.0,       0.0,        0.0,       0.0,
      0.0,       0.0,        0.0,       1.0,       2.0,       3.0,        4.0,       5.0,        6.0,
      7.0, //
      20.414213, 19.414213,  18.414213, 17.414213, 16.414213, 15.414213,  14.414213, 13.414213,  12.414213, 11.414213,
      10.414213, 9.414213,   8.414213,  7.4142137, 6.4142137, 5.4142137,  4.4142137, 3.4142137,  2.4142137, 1.4142135,
      1.0,       1.0,        1.0,       1.0,       1.0,       1.0,        1.0,       1.0,        1.0,       1.0,
      1.0,       1.0,        1.0,       1.0,       1.0,       1.0,        1.0,       1.0,        1.0,       1.0,
      1.0,       1.0,        1.0,       1.4142135, 2.4142137, 3.4142137,  4.4142137, 5.4142137,  6.4142137,
      7.4142137, //
      20.828426, 19.828426,  18.828426, 17.828426, 16.828426, 15.828426,  14.828426, 13.828426,  12.828426, 11.828426,
      10.828426, 9.828426,   8.828427,  7.8284273, 6.8284273, 5.8284273,  4.8284273, 3.828427,   2.828427,  2.4142137,
      2.0,       2.0,        2.0,       2.0,       2.0,       2.0,        2.0,       2.0,        2.0,       2.0,
      2.0,       2.0,        2.0,       2.0,       2.0,       2.0,        2.0,       2.0,        2.0,       2.0,
      2.0,       2.0,        2.0,       2.4142137, 2.828427,  3.828427,   4.8284273, 5.8284273,  6.8284273,
      7.8284273, //
      21.24264,  20.24264,   19.24264,  18.24264,  17.24264,  16.24264,   15.24264,  14.24264,   13.24264,  12.24264,
      11.24264,  10.2426405, 9.2426405, 8.2426405, 7.2426405, 6.2426405,  5.2426405, 4.2426405,  3.828427,  3.4142137,
      3.0,       3.0,        3.0,       3.0,       3.0,       3.0,        3.0,       3.0,        3.0,       3.0,
      3.0,       3.0,        3.0,       3.0,       3.0,       3.0,        3.0,       3.0,        3.0,       3.0,
      3.0,       3.0,        3.0,       3.4142137, 3.828427,  4.2426405,  5.2426405, 6.2426405,  7.2426405,
      8.2426405, //
      21.656853, 20.656853,  19.656853, 18.656853, 17.656853, 16.656853,  15.656853, 14.656853,  13.656853, 12.656853,
      11.656854, 10.656854,  9.656854,  8.656854,  7.656854,  6.656854,   5.656854,  5.2426405,  4.8284273, 4.4142137,
      4.0,       4.0,        4.0,       4.0,       4.0,       4.0,        4.0,       4.0,        4.0,       4.0,
      4.0,       4.0,        4.0,       4.0,       4.0,       4.0,        4.0,       4.0,        4.0,       4.0,
      4.0,       4.0,        4.0,       4.4142137, 4.8284273, 5.2426405,  5.656854,  6.656854,   7.656854,
      8.656854, //
      22.071066, 21.071066,  20.071066, 19.071066, 18.071066, 17.071066,  16.071066, 15.071066,  14.071066, 13.071067,
      12.071067, 11.071067,  10.071067, 9.071068,  8.071068,  7.071068,   6.656854,  6.2426405,  5.8284273, 5.4142137,
      5.0,       5.0,        5.0,       5.0,       5.0,       5.0,        5.0,       5.0,        5.0,       5.0,
      5.0,       5.0,        5.0,       5.0,       5.0,       5.0,        5.0,       5.0,        5.0,       5.0,
      5.0,       5.0,        5.0,       5.4142137, 5.8284273, 6.2426405,  6.656854,  7.071068,   8.071068,
      9.071068, //
      22.48528,  21.48528,   20.48528,  19.48528,  18.48528,  17.48528,   16.48528,  15.485279,  14.48528,  13.48528,
      12.48528,  11.48528,   10.485281, 9.485281,  8.485281,  8.071068,   7.656854,  7.2426405,  6.8284273, 6.4142137,
      6.0,       6.0,        6.0,       6.0,       6.0,       6.0,        6.0,       6.0,        6.0,       6.0,
      6.0,       6.0,        6.0,       6.0,       6.0,       6.0,        6.0,       6.0,        6.0,       6.0,
      6.0,       6.0,        6.0,       6.4142137, 6.8284273, 7.2426405,  7.656854,  8.071068,   8.485281,
      9.485281, //
      22.899492, 21.899492,  20.899492, 19.899492, 18.899492, 17.899492,  16.899492, 15.899493,  14.899493, 13.899493,
      12.899493, 11.899494,  10.899494, 9.899494,  9.485281,  9.071068,   8.656854,  8.2426405,  7.8284273, 7.4142137,
      7.0,       7.0,        7.0,       7.0,       7.0,       7.0,        7.0,       7.0,        7.0,       7.0,
      7.0,       7.0,        7.0,       7.0,       7.0,       7.0,        7.0,       7.0,        7.0,       7.0,
      7.0,       7.0,        7.0,       7.4142137, 7.8284273, 8.2426405,  8.656854,  9.071068,   9.485281,
      9.899494, //
      23.313705, 22.313705,  21.313705, 20.313705, 19.313705, 18.313705,  17.313705, 16.313705,  15.313706, 14.313706,
      13.313707, 12.313707,  11.313707, 10.899494, 10.485281, 10.071067,  9.656854,  9.2426405,  8.828427,  8.414213,
      8.0,       8.0,        8.0,       8.0,       8.0,       8.0,        8.0,       8.0,        8.0,       8.0,
      8.0,       8.0,        8.0,       8.0,       8.0,       8.0,        8.0,       8.0,        8.0,       8.0,
      8.0,       8.0,        8.0,       8.414213,  8.828427,  9.2426405,  9.656854,  10.071067,  10.485281,
      10.899494, //
      23.727919, 22.727919,  21.727919, 20.727919, 19.727919, 18.727919,  17.727919, 16.72792,   15.72792,  14.727921,
      13.727921, 12.727921,  12.313707, 11.899494, 11.48528,  11.071067,  10.656854, 10.2426405, 9.828426,  9.414213,
      9.0,       9.0,        9.0,       9.0,       9.0,       9.0,        9.0,       9.0,        9.0,       9.0,
      9.0,       9.0,        9.0,       9.0,       9.0,       9.0,        9.0,       9.0,        9.0,       9.0,
      9.0,       9.0,        9.0,       9.414213,  9.828426,  10.2426405, 10.656854, 11.071067,  11.48528,
      11.899494, //
      24.142132, 23.142132,  22.142132, 21.142132, 20.142132, 19.142132,  18.142134, 17.142134,  16.142134, 15.142134,
      14.142134, 13.727921,  13.313707, 12.899493, 12.48528,  12.071067,  11.656854, 11.24264,   10.828426, 10.414213,
      10.0,      10.0,       10.0,      10.0,      10.0,      10.0,       10.0,      10.0,       10.0,      10.0,
      10.0,      10.0,       10.0,      10.0,      10.0,      10.0,       10.0,      10.0,       10.0,      10.0,
      10.0,      10.0,       10.0,      10.414213, 10.828426, 11.24264,   11.656854, 12.071067,  12.48528,
      12.899493 //
  };

  std::uint8_t img_data[WIDTH * HEIGHT];
  std::memset(img_data, 0, WIDTH * HEIGHT);

  dt::image2d_view          img(img_data, WIDTH, HEIGHT, WIDTH);
  dt::image2d_view          ref_dist(ref_data, WIDTH, HEIGHT, WIDTH * sizeof(float));
  dt::image2d<std::uint8_t> mask(WIDTH, HEIGHT);
  dt::fill(mask, std::uint8_t(0));
  for (int y = 20; y < 30; y++)
  {
    for (int x = 20; x < 43; x++)
      mask(x, y) = 1;
  }

  auto       d_img  = dt::host_to_device(img);
  auto       d_mask = dt::host_to_device(mask);
  const auto d_dist = dt::generalised_distance_transform(d_img, d_mask, 0.0);
  const auto dist   = dt::device_to_host(d_dist);

  ASSERT_IMAGES_EQ(dist, ref_dist);
}

TEST(DistanceTransform, GeodesicFastGeodis)
{
  static constexpr int WIDTH  = 36;
  static constexpr int HEIGHT = 34;

  std::uint8_t img_data[] = {
      130, 135, 138, 144, 152, 155, 154, 161, 165, 170, 172, 171, 173, 174, 177, 172, 173, 174,
      176, 176, 177, 178, 178, 178, 178, 181, 186, 184, 178, 180, 187, 191, 191, 190, 189, 187, //
      130, 135, 138, 145, 153, 157, 157, 161, 165, 170, 171, 172, 170, 171, 173, 170, 171, 172,
      173, 174, 173, 173, 173, 173, 172, 175, 180, 178, 171, 169, 173, 185, 185, 185, 185, 185, //
      130, 135, 139, 146, 156, 160, 160, 166, 169, 173, 174, 173, 172, 171, 171, 168, 169, 170,
      170, 170, 170, 169, 169, 168, 167, 170, 176, 177, 173, 168, 167, 178, 178, 179, 182, 182, //
      129, 135, 140, 147, 158, 163, 162, 168, 170, 172, 173, 172, 169, 168, 167, 166, 166, 165,
      165, 164, 164, 164, 164, 159, 158, 161, 168, 175, 175, 173, 169, 174, 175, 176, 177, 180, //
      129, 136, 141, 148, 158, 163, 163, 167, 166, 165, 164, 163, 160, 158, 156, 153, 151, 151,
      150, 150, 150, 152, 153, 147, 146, 147, 153, 161, 168, 169, 167, 172, 173, 172, 175, 179, //
      128, 137, 143, 151, 158, 161, 159, 166, 162, 157, 150, 147, 142, 138, 136, 125, 123, 120,
      119, 120, 124, 128, 132, 132, 135, 137, 140, 148, 158, 162, 163, 169, 168, 168, 172, 176, //
      127, 137, 145, 153, 159, 160, 155, 153, 146, 135, 124, 116, 111, 105, 101, 88,  85,  81,
      80,  82,  89,  97,  102, 109, 117, 124, 128, 136, 148, 156, 157, 163, 162, 163, 168, 175, //
      128, 138, 146, 153, 159, 158, 154, 133, 122, 107, 94,  83,  76,  69,  65,  62,  59,  54,
      52,  55,  64,  74,  80,  83,  96,  108, 115, 124, 138, 147, 149, 157, 156, 158, 165, 173, //
      126, 134, 153, 154, 153, 159, 137, 119, 104, 87,  80,  70,  58,  51,  52,  53,  48,  46,
      48,  49,  48,  52,  56,  72,  74,  86,  103, 118, 125, 131, 136, 150, 153, 156, 161, 171, //
      128, 141, 154, 144, 128, 122, 100, 83,  75,  68,  66,  62,  56,  54,  56,  51,  46,  47,
      49,  52,  52,  55,  59,  64,  65,  71,  80,  89,  99,  114, 129, 138, 143, 149, 157, 169, //
      125, 138, 138, 117, 92,  85,  66,  61,  61,  64,  68,  69,  69,  71,  74,  83,  80,  77,
      79,  79,  75,  74,  76,  66,  65,  67,  68,  68,  73,  92,  110, 121, 130, 141, 153, 168, //
      128, 132, 116, 90,  70,  74,  69,  68,  73,  81,  87,  88,  88,  91,  94,  96,  91,  87,
      86,  80,  70,  64,  63,  62,  62,  64,  65,  64,  66,  79,  92,  110, 123, 139, 153, 167, //
      132, 131, 106, 82,  69,  81,  87,  81,  88,  95,  98,  96,  97,  98,  98,  95,  91,  87,
      87,  81,  71,  64,  64,  57,  52,  52,  57,  61,  66,  74,  84,  106, 122, 140, 155, 168, //
      126, 127, 99,  83,  72,  81,  87,  90,  95,  98,  95,  93,  94,  92,  89,  98,  95,  95,
      100, 98,  95,  92,  94,  74,  65,  58,  58,  59,  61,  67,  74,  98,  118, 141, 157, 170, //
      119, 120, 95,  85,  76,  80,  84,  95,  96,  92,  84,  80,  80,  76,  69,  66,  64,  68,
      74,  75,  75,  76,  79,  84,  79,  76,  72,  66,  61,  62,  67,  88,  111, 138, 159, 172, //
      119, 119, 92,  89,  84,  88,  92,  96,  92,  83,  71,  65,  64,  58,  48,  31,  29,  30,
      35,  36,  36,  37,  40,  65,  72,  82,  85,  77,  65,  64,  69,  80,  105, 135, 157, 173, //
      109, 120, 102, 94,  89,  94,  91,  96,  85,  75,  65,  47,  32,  35,  50,  28,  37,  38,
      63,  92,  68,  34,  43,  79,  76,  76,  83,  89,  88,  78,  68,  82,  97,  125, 156, 177, //
      110, 124, 109, 102, 99,  102, 97,  101, 82,  55,  34,  32,  49,  71,  84,  53,  43,  27,
      45,  79,  67,  43,  57,  117, 107, 93,  78,  70,  72,  81,  89,  86,  100, 126, 156, 177, //
      111, 128, 117, 113, 110, 110, 103, 92,  75,  46,  28,  45,  82,  106, 111, 48,  42,  33,
      44,  55,  40,  42,  79,  159, 156, 142, 116, 89,  77,  82,  92,  91,  104, 128, 157, 177, //
      111, 131, 122, 120, 116, 115, 104, 89,  72,  49,  43,  66,  101, 122, 126, 62,  52,  40,
      43,  44,  37,  60,  109, 165, 168, 161, 139, 110, 91,  88,  93,  100, 109, 131, 158, 178, //
      111, 131, 125, 124, 120, 117, 105, 100, 77,  57,  58,  74,  94,  114, 132, 113, 79,  48,
      49,  68,  79,  101, 132, 136, 134, 125, 110, 95,  91,  99,  109, 108, 117, 135, 160, 179, //
      113, 133, 127, 129, 125, 124, 111, 103, 87,  80,  86,  89,  89,  98,  111, 116, 97,  84,
      90,  103, 113, 123, 132, 116, 111, 104, 97,  93,  97,  105, 110, 119, 124, 139, 162, 181, //
      119, 137, 132, 136, 135, 135, 125, 112, 111, 111, 112, 107, 102, 98,  97,  100, 102, 111,
      117, 115, 120, 122, 117, 117, 116, 114, 112, 112, 111, 109, 109, 126, 129, 143, 165, 183, //
      123, 141, 136, 142, 144, 146, 136, 140, 139, 128, 110, 106, 113, 116, 112, 120, 106, 99,
      98,  106, 125, 127, 108, 123, 119, 117, 114, 112, 115, 121, 123, 130, 133, 145, 166, 184, //
      118, 145, 147, 150, 152, 150, 151, 148, 140, 129, 120, 115, 117, 122, 125, 124, 123, 120,
      119, 118, 119, 120, 121, 115, 121, 125, 124, 121, 121, 127, 132, 136, 136, 149, 174, 188, //
      127, 149, 149, 153, 155, 153, 152, 150, 144, 136, 128, 122, 119, 118, 118, 122, 119, 114,
      109, 107, 107, 109, 110, 120, 124, 127, 127, 127, 130, 137, 143, 138, 139, 152, 174, 190, //
      140, 153, 151, 155, 160, 157, 156, 152, 150, 146, 140, 133, 125, 119, 117, 115, 111, 109,
      109, 110, 115, 121, 124, 134, 133, 133, 133, 136, 141, 146, 150, 141, 143, 155, 176, 190, //
      148, 153, 151, 158, 165, 162, 163, 155, 155, 154, 151, 145, 138, 131, 127, 122, 123, 123,
      126, 133, 139, 145, 149, 147, 144, 142, 143, 147, 149, 149, 148, 143, 145, 156, 175, 189, //
      151, 151, 150, 161, 167, 166, 169, 159, 160, 159, 158, 157, 154, 150, 148, 148, 149, 151,
      153, 155, 154, 154, 154, 152, 150, 149, 152, 156, 154, 150, 144, 143, 146, 157, 173, 186, //
      151, 151, 151, 163, 169, 168, 174, 165, 165, 165, 165, 166, 165, 165, 165, 163, 165, 166,
      167, 166, 162, 158, 155, 151, 151, 153, 157, 159, 157, 151, 145, 144, 148, 158, 171, 183, //
      152, 153, 154, 165, 168, 168, 175, 170, 170, 171, 170, 171, 172, 172, 172, 168, 169, 169,
      169, 168, 165, 163, 161, 156, 156, 157, 159, 158, 156, 149, 146, 146, 150, 159, 170, 182, //
      153, 155, 157, 167, 168, 168, 175, 174, 174, 174, 174, 174, 172, 171, 171, 176, 175, 173,
      171, 167, 164, 162, 160, 164, 163, 162, 159, 155, 150, 147, 145, 146, 153, 161, 171, 182, //
      152, 157, 161, 165, 169, 173, 175, 172, 174, 177, 179, 179, 178, 175, 174, 174, 173, 173,
      173, 173, 171, 166, 162, 162, 160, 157, 154, 153, 151, 144, 136, 145, 154, 165, 171, 178, //
      152, 155, 161, 165, 169, 173, 175, 174, 176, 179, 181, 181, 180, 177, 176, 173, 173, 172,
      173, 173, 172, 168, 165, 166, 162, 157, 153, 153, 151, 146, 141, 144, 155, 165, 171, 179 //
  };

  float ref_data[] = {
      125.0, 130.0, 133.0, 139.0, 141.0, 140.0, 141.0, 138.0, 142.0, 147.0, 149.0, 148.0,
      150.0, 151.0, 154.0, 153.0, 154.0, 155.0, 155.0, 155.0, 156.0, 157.0, 157.0, 157.0,
      157.0, 158.0, 163.0, 161.0, 155.0, 157.0, 160.0, 164.0, 164.0, 163.0, 162.0, 160.0, //
      125.0, 130.0, 133.0, 138.0, 140.0, 138.0, 138.0, 138.0, 142.0, 147.0, 148.0, 149.0,
      149.0, 150.0, 152.0, 151.0, 152.0, 153.0, 154.0, 153.0, 152.0, 152.0, 152.0, 152.0,
      151.0, 154.0, 157.0, 155.0, 150.0, 148.0, 152.0, 158.0, 158.0, 158.0, 158.0, 158.0, //
      125.0, 130.0, 134.0, 137.0, 137.0, 137.0, 137.0, 143.0, 146.0, 150.0, 151.0, 150.0,
      149.0, 150.0, 150.0, 153.0, 152.0, 153.0, 153.0, 153.0, 153.0, 152.0, 152.0, 151.0,
      150.0, 149.0, 153.0, 154.0, 150.0, 147.0, 148.0, 153.0, 153.0, 154.0, 155.0, 155.0, //
      124.0, 130.0, 133.0, 136.0, 135.0, 140.0, 139.0, 145.0, 147.0, 149.0, 150.0, 149.0,
      152.0, 153.0, 154.0, 153.0, 153.0, 152.0, 152.0, 151.0, 151.0, 151.0, 151.0, 146.0,
      145.0, 144.0, 147.0, 152.0, 152.0, 150.0, 146.0, 149.0, 150.0, 151.0, 152.0, 153.0, //
      124.0, 129.0, 132.0, 135.0, 135.0, 140.0, 140.0, 144.0, 143.0, 144.0, 145.0, 146.0,
      149.0, 149.0, 147.0, 144.0, 142.0, 142.0, 141.0, 141.0, 141.0, 143.0, 142.0, 136.0,
      135.0, 134.0, 136.0, 140.0, 145.0, 146.0, 144.0, 147.0, 148.0, 147.0, 150.0, 152.0, //
      123.0, 128.0, 134.0, 132.0, 135.0, 138.0, 138.0, 143.0, 147.0, 152.0, 155.0, 152.0,
      147.0, 143.0, 141.0, 130.0, 128.0, 125.0, 124.0, 123.0, 119.0, 119.0, 123.0, 123.0,
      126.0, 126.0, 127.0, 131.0, 137.0, 139.0, 140.0, 144.0, 143.0, 143.0, 147.0, 149.0, //
      122.0, 128.0, 134.0, 130.0, 136.0, 137.0, 138.0, 140.0, 147.0, 148.0, 149.0, 141.0,
      136.0, 130.0, 126.0, 113.0, 110.0, 106.0, 105.0, 103.0, 96.0,  92.0,  93.0,  100.0,
      108.0, 115.0, 117.0, 123.0, 131.0, 135.0, 134.0, 140.0, 139.0, 140.0, 143.0, 148.0, //
      121.0, 127.0, 135.0, 130.0, 136.0, 135.0, 139.0, 138.0, 135.0, 132.0, 119.0, 108.0,
      105.0, 98.0,  94.0,  91.0,  88.0,  83.0,  81.0,  84.0,  87.0,  81.0,  75.0,  74.0,
      87.0,  99.0,  106.0, 113.0, 121.0, 130.0, 128.0, 134.0, 133.0, 135.0, 140.0, 146.0, //
      119.0, 123.0, 130.0, 131.0, 130.0, 136.0, 134.0, 132.0, 129.0, 112.0, 105.0, 99.0,
      91.0,  86.0,  85.0,  86.0,  81.0,  81.0,  79.0,  78.0,  79.0,  75.0,  71.0,  67.0,
      65.0,  77.0,  94.0,  107.0, 114.0, 114.0, 119.0, 127.0, 130.0, 133.0, 136.0, 144.0, //
      117.0, 118.0, 131.0, 121.0, 113.0, 119.0, 113.0, 108.0, 100.0, 93.0,  95.0,  95.0,
      89.0,  87.0,  89.0,  84.0,  81.0,  80.0,  78.0,  75.0,  75.0,  72.0,  68.0,  63.0,
      62.0,  62.0,  71.0,  80.0,  88.0,  103.0, 112.0, 117.0, 120.0, 126.0, 132.0, 142.0, //
      114.0, 115.0, 115.0, 102.0, 91.0,  98.0,  95.0,  100.0, 100.0, 97.0,  93.0,  92.0,
      92.0,  90.0,  87.0,  78.0,  79.0,  76.0,  74.0,  74.0,  70.0,  69.0,  71.0,  63.0,
      62.0,  60.0,  59.0,  59.0,  64.0,  81.0,  99.0,  104.0, 109.0, 118.0, 128.0, 141.0, //
      111.0, 109.0, 101.0, 89.0,  91.0,  87.0,  92.0,  93.0,  88.0,  80.0,  74.0,  73.0,
      73.0,  70.0,  67.0,  67.0,  70.0,  74.0,  75.0,  75.0,  65.0,  59.0,  60.0,  61.0,
      61.0,  61.0,  60.0,  59.0,  57.0,  68.0,  81.0,  99.0,  102.0, 116.0, 128.0, 140.0, //
      109.0, 108.0, 91.0,  81.0,  92.0,  80.0,  74.0,  80.0,  73.0,  66.0,  69.0,  67.0,
      68.0,  69.0,  69.0,  66.0,  70.0,  74.0,  74.0,  74.0,  66.0,  59.0,  59.0,  60.0,
      65.0,  65.0,  60.0,  56.0,  57.0,  63.0,  73.0,  95.0,  101.0, 115.0, 128.0, 139.0, //
      103.0, 104.0, 84.0,  80.0,  89.0,  80.0,  74.0,  71.0,  66.0,  69.0,  66.0,  64.0,
      65.0,  63.0,  60.0,  69.0,  66.0,  66.0,  65.0,  63.0,  60.0,  57.0,  59.0,  49.0,
      52.0,  59.0,  59.0,  58.0,  56.0,  56.0,  63.0,  87.0,  97.0,  114.0, 128.0, 137.0, //
      96.0,  97.0,  80.0,  78.0,  85.0,  81.0,  77.0,  66.0,  67.0,  63.0,  55.0,  51.0,
      51.0,  47.0,  40.0,  41.0,  43.0,  43.0,  49.0,  48.0,  48.0,  47.0,  44.0,  49.0,
      44.0,  41.0,  45.0,  51.0,  56.0,  55.0,  56.0,  77.0,  90.0,  111.0, 126.0, 139.0, //
      96.0,  96.0,  77.0,  74.0,  77.0,  73.0,  69.0,  67.0,  63.0,  54.0,  42.0,  36.0,
      35.0,  29.0,  23.0,  14.0,  16.0,  15.0,  10.0,  11.0,  11.0,  12.0,  11.0,  30.0,
      37.0,  47.0,  50.0,  50.0,  52.0,  53.0,  58.0,  69.0,  84.0,  108.0, 124.0, 140.0, //
      106.0, 97.0,  79.0,  79.0,  74.0,  71.0,  70.0,  67.0,  56.0,  46.0,  36.0,  52.0,
      39.0,  36.0,  21.0,  17.0,  8.0,   7.0,   18.0,  47.0,  23.0,  13.0,  8.0,   44.0,
      41.0,  41.0,  48.0,  54.0,  55.0,  59.0,  57.0,  71.0,  76.0,  98.0,  123.0, 142.0, //
      107.0, 95.0,  86.0,  79.0,  76.0,  73.0,  68.0,  72.0,  53.0,  46.0,  41.0,  39.0,
      50.0,  42.0,  49.0,  18.0,  8.0,   18.0,  0.0,   34.0,  22.0,  8.0,   22.0,  82.0,
      72.0,  58.0,  43.0,  51.0,  53.0,  62.0,  66.0,  69.0,  73.0,  97.0,  123.0, 142.0, //
      108.0, 93.0,  88.0,  84.0,  81.0,  81.0,  74.0,  63.0,  60.0,  53.0,  43.0,  52.0,
      53.0,  71.0,  70.0,  13.0,  7.0,   12.0,  1.0,   10.0,  5.0,   7.0,   44.0,  116.0,
      119.0, 107.0, 81.0,  54.0,  58.0,  63.0,  63.0,  64.0,  75.0,  95.0,  124.0, 142.0, //
      108.0, 96.0,  87.0,  85.0,  83.0,  84.0,  75.0,  66.0,  63.0,  56.0,  54.0,  69.0,
      72.0,  79.0,  83.0,  21.0,  11.0,  5.0,   2.0,   1.0,   8.0,   25.0,  66.0,  122.0,
      125.0, 122.0, 104.0, 75.0,  56.0,  59.0,  64.0,  71.0,  76.0,  98.0,  123.0, 143.0, //
      108.0, 96.0,  90.0,  89.0,  85.0,  82.0,  76.0,  77.0,  68.0,  64.0,  65.0,  77.0,
      65.0,  71.0,  89.0,  70.0,  38.0,  7.0,   6.0,   25.0,  36.0,  58.0,  89.0,  93.0,
      95.0,  90.0,  75.0,  60.0,  56.0,  64.0,  74.0,  75.0,  84.0,  100.0, 125.0, 144.0, //
      110.0, 98.0,  92.0,  94.0,  90.0,  89.0,  76.0,  78.0,  78.0,  71.0,  73.0,  70.0,
      70.0,  61.0,  68.0,  73.0,  54.0,  41.0,  47.0,  60.0,  70.0,  80.0,  89.0,  81.0,
      76.0,  69.0,  62.0,  58.0,  62.0,  70.0,  75.0,  84.0,  89.0,  104.0, 127.0, 146.0, //
      112.0, 100.0, 97.0,  99.0,  98.0,  98.0,  88.0,  75.0,  74.0,  74.0,  75.0,  70.0,
      65.0,  61.0,  60.0,  57.0,  59.0,  68.0,  74.0,  72.0,  77.0,  79.0,  82.0,  82.0,
      81.0,  79.0,  77.0,  77.0,  76.0,  74.0,  74.0,  91.0,  94.0,  108.0, 130.0, 148.0, //
      114.0, 104.0, 99.0,  105.0, 107.0, 109.0, 99.0,  97.0,  96.0,  87.0,  73.0,  69.0,
      76.0,  73.0,  69.0,  77.0,  63.0,  62.0,  63.0,  71.0,  82.0,  84.0,  91.0,  84.0,
      84.0,  82.0,  79.0,  77.0,  80.0,  86.0,  88.0,  95.0,  98.0,  110.0, 131.0, 149.0, //
      119.0, 108.0, 110.0, 113.0, 111.0, 109.0, 108.0, 105.0, 97.0,  86.0,  81.0,  76.0,
      74.0,  79.0,  82.0,  81.0,  80.0,  77.0,  78.0,  79.0,  80.0,  81.0,  82.0,  88.0,
      84.0,  88.0,  89.0,  86.0,  86.0,  92.0,  97.0,  101.0, 101.0, 114.0, 139.0, 153.0, //
      126.0, 112.0, 112.0, 112.0, 112.0, 110.0, 109.0, 107.0, 101.0, 93.0,  85.0,  79.0,
      76.0,  75.0,  75.0,  79.0,  78.0,  83.0,  84.0,  86.0,  86.0,  88.0,  89.0,  83.0,
      87.0,  90.0,  90.0,  90.0,  93.0,  100.0, 106.0, 103.0, 104.0, 117.0, 139.0, 155.0, //
      121.0, 116.0, 114.0, 112.0, 117.0, 114.0, 113.0, 109.0, 107.0, 103.0, 97.0,  90.0,
      82.0,  76.0,  76.0,  78.0,  82.0,  84.0,  84.0,  85.0,  90.0,  90.0,  87.0,  97.0,
      96.0,  96.0,  96.0,  99.0,  104.0, 109.0, 113.0, 106.0, 108.0, 120.0, 141.0, 155.0, //
      117.0, 116.0, 114.0, 115.0, 122.0, 119.0, 120.0, 112.0, 112.0, 111.0, 108.0, 102.0,
      95.0,  88.0,  84.0,  81.0,  82.0,  82.0,  85.0,  92.0,  98.0,  104.0, 108.0, 110.0,
      107.0, 105.0, 106.0, 110.0, 112.0, 112.0, 111.0, 108.0, 110.0, 121.0, 140.0, 154.0, //
      114.0, 114.0, 115.0, 118.0, 124.0, 123.0, 126.0, 116.0, 117.0, 116.0, 115.0, 114.0,
      111.0, 107.0, 105.0, 105.0, 106.0, 108.0, 110.0, 112.0, 113.0, 113.0, 113.0, 111.0,
      113.0, 112.0, 115.0, 117.0, 117.0, 113.0, 109.0, 108.0, 111.0, 122.0, 138.0, 151.0, //
      114.0, 114.0, 114.0, 120.0, 126.0, 125.0, 131.0, 122.0, 122.0, 122.0, 122.0, 123.0,
      122.0, 122.0, 122.0, 120.0, 122.0, 123.0, 124.0, 123.0, 119.0, 117.0, 114.0, 112.0,
      112.0, 114.0, 116.0, 118.0, 118.0, 114.0, 110.0, 109.0, 113.0, 123.0, 136.0, 148.0, //
      115.0, 116.0, 117.0, 122.0, 125.0, 125.0, 132.0, 127.0, 127.0, 128.0, 127.0, 128.0,
      129.0, 129.0, 129.0, 125.0, 126.0, 126.0, 126.0, 125.0, 122.0, 120.0, 120.0, 115.0,
      115.0, 116.0, 118.0, 117.0, 119.0, 114.0, 111.0, 111.0, 115.0, 124.0, 135.0, 147.0, //
      116.0, 118.0, 120.0, 124.0, 125.0, 125.0, 132.0, 131.0, 131.0, 131.0, 131.0, 131.0,
      129.0, 128.0, 128.0, 133.0, 132.0, 130.0, 128.0, 124.0, 121.0, 121.0, 119.0, 123.0,
      122.0, 121.0, 118.0, 120.0, 115.0, 112.0, 112.0, 111.0, 118.0, 126.0, 136.0, 147.0, //
      117.0, 120.0, 124.0, 126.0, 126.0, 130.0, 132.0, 133.0, 131.0, 134.0, 136.0, 136.0,
      135.0, 132.0, 131.0, 131.0, 130.0, 130.0, 130.0, 130.0, 128.0, 123.0, 121.0, 121.0,
      123.0, 120.0, 119.0, 118.0, 116.0, 113.0, 121.0, 112.0, 119.0, 130.0, 136.0, 143.0, //
      117.0, 120.0, 124.0, 126.0, 126.0, 130.0, 132.0, 131.0, 133.0, 136.0, 138.0, 138.0,
      137.0, 134.0, 133.0, 130.0, 130.0, 131.0, 130.0, 130.0, 129.0, 125.0, 124.0, 125.0,
      121.0, 120.0, 118.0, 118.0, 116.0, 115.0, 116.0, 113.0, 120.0, 130.0, 136.0, 144.0, //
  };

  dt::image2d_view          img(img_data, WIDTH, HEIGHT, WIDTH);
  dt::image2d_view          ref_dist(ref_data, WIDTH, HEIGHT, WIDTH * sizeof(float));
  dt::image2d<std::uint8_t> mask(WIDTH, HEIGHT);
  dt::fill(mask, std::uint8_t(0));
  mask(img.width() / 2, img.height() / 2) = 1;

  auto       d_img  = dt::host_to_device(img);
  auto       d_mask = dt::host_to_device(mask);
  const auto d_dist = dt::generalised_distance_transform(d_img, d_mask, 1.0);
  const auto dist   = dt::device_to_host(d_dist);

  ASSERT_IMAGES_EQ(dist, ref_dist);
}

/*
 * Experimental methods tests
 */

static constexpr int RANDOM_WIDTH  = 250;
static constexpr int RANDOM_HEIGHT = 230;

TEST(DistanceTransform, EuclidianBlocks)
{
  const auto                img = dt::random_image2d<std::uint8_t>(RANDOM_WIDTH, RANDOM_HEIGHT);
  dt::image2d<std::uint8_t> mask(RANDOM_WIDTH, RANDOM_HEIGHT);
  dt::fill(mask, std::uint8_t(0));
  mask(img.width() / 2, img.height() / 2) = 1;

  auto d_img  = dt::host_to_device(img);
  auto d_mask = dt::host_to_device(mask);

  const auto d_dist1 = dt::generalised_distance_transform(d_img, d_mask, 0.0f);
  const auto d_dist2 = dt::generalised_distance_transform_blocks(d_img, d_mask, 0.0f);

  const auto dist1 = dt::device_to_host(d_dist1);
  const auto dist2 = dt::device_to_host(d_dist2);

  ASSERT_IMAGES_EQ(dist1, dist2);
}

TEST(DistanceTransform, GeodesicBlocks)
{
  const auto                img = dt::random_image2d<std::uint8_t>(RANDOM_WIDTH, RANDOM_HEIGHT);
  dt::image2d<std::uint8_t> mask(RANDOM_WIDTH, RANDOM_HEIGHT);
  dt::fill(mask, std::uint8_t(0));
  mask(img.width() / 2, img.height() / 2) = 1;

  auto d_img  = dt::host_to_device(img);
  auto d_mask = dt::host_to_device(mask);

  const auto d_dist1 = dt::generalised_distance_transform(d_img, d_mask, 1.0f);
  const auto d_dist2 = dt::generalised_distance_transform_blocks(d_img, d_mask, 1.0f);

  const auto dist1 = dt::device_to_host(d_dist1);
  const auto dist2 = dt::device_to_host(d_dist2);

  ASSERT_IMAGES_EQ(dist1, dist2);
}

TEST(DistanceTransform, EuclidianTask)
{
  const auto                img = dt::random_image2d<std::uint8_t>(RANDOM_WIDTH, RANDOM_HEIGHT);
  dt::image2d<std::uint8_t> mask(RANDOM_WIDTH, RANDOM_HEIGHT);
  dt::fill(mask, std::uint8_t(0));
  mask(img.width() / 2, img.height() / 2) = 1;

  auto d_img  = dt::host_to_device(img);
  auto d_mask = dt::host_to_device(mask);

  const auto d_dist1 = dt::generalised_distance_transform(d_img, d_mask, 0.0f);
  const auto d_dist2 = dt::generalised_distance_transform_task(d_img, d_mask, 0.0f);

  const auto dist1 = dt::device_to_host(d_dist1);
  const auto dist2 = dt::device_to_host(d_dist2);

  ASSERT_IMAGES_EQ(dist1, dist2);
}

TEST(DistanceTransform, GeodesicTask)
{
  const auto                img = dt::random_image2d<std::uint8_t>(RANDOM_WIDTH, RANDOM_HEIGHT);
  dt::image2d<std::uint8_t> mask(RANDOM_WIDTH, RANDOM_HEIGHT);
  dt::fill(mask, std::uint8_t(0));
  mask(img.width() / 2, img.height() / 2) = 1;

  auto d_img  = dt::host_to_device(img);
  auto d_mask = dt::host_to_device(mask);

  const auto d_dist1 = dt::generalised_distance_transform(d_img, d_mask, 1.0f);
  const auto d_dist2 = dt::generalised_distance_transform_task(d_img, d_mask, 1.0f);

  const auto dist1 = dt::device_to_host(d_dist1);
  const auto dist2 = dt::device_to_host(d_dist2);

  ASSERT_IMAGES_EQ(dist1, dist2);
}